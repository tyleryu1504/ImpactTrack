<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Dashboard – ImpactTrack</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <script type="module">
    import {
      requireAuth,
      setupNav,
      setupSearchBar
    } from './auth-common.js';

    import { auth } from './firebase-init.js';
    import {
      logActivity,
      getUserActivities
    } from './firestore/activities.js';

    // Protect & render nav
    requireAuth();
    setupNav();

    // References
    const user = auth.currentUser;

    // Log form submit
    document
      .getElementById('log-form')
      .addEventListener('submit', async e => {
        e.preventDefault();
        const type   = document.getElementById('activity-type').value;
        const amount = Number(document.getElementById('activity-amount').value);
        const note   = document.getElementById('activity-desc').value.trim();
        const unit   = type === 'compost' ? 'kg' : 'minutes';
        await logActivity(type, amount, unit, note);
        document.getElementById('activity-amount').value = '';
        document.getElementById('activity-desc').value = '';
      });

    // Display feed & stats
    getUserActivities(user.uid, activities => {
      const feed = document.getElementById('activity-feed');
      feed.innerHTML = '';
      let compost = 0, cleanup = 0;
      activities.forEach(data => {
        const item = document.createElement('div');
        const date = data.createdAt?.toDate().toLocaleString();
        item.textContent = `${data.amount} ${data.unit} ${data.type} – ${data.note} – ${date}`;
        if (data.type === 'compost') {
          compost += data.amount;
        } else if (data.type === 'cleanup') {
          cleanup += data.amount;
        }
        feed.appendChild(item);
      });
      // Update stats
      document.getElementById('total-compost').textContent = compost;
      document.getElementById('total-cleanup').textContent = cleanup;
    });

    // Initialize search here
    setupSearchBar();
  </script>

  <h1>Your Activities</h1>

  <div id="user-stats">
    <p>Total composted: <span id="total-compost">0</span> kg</p>
    <p>Total cleanup: <span id="total-cleanup">0</span> minutes</p>
  </div>

  <form id="log-form">
    <select id="activity-type">
      <option value="compost">Compost</option>
      <option value="cleanup">Cleanup</option>
    </select>
    <input
      type="number"
      id="activity-amount"
      placeholder="Amount (kg or minutes)"
      required
    >
    <input
      type="text"
      id="activity-desc"
      placeholder="Description"
    >
    <button type="submit">Log Activity</button>
  </form>

  <div id="activity-feed"></div>

  <!-- SEARCH USERS (moved here, removed from all other pages) -->
  <section id="user-search-section">
    <h2>Search Users</h2>
    <input id="user-search" type="text" placeholder="Search users…">
    <div id="search-results"></div>
  </section>

</body>
</html>
