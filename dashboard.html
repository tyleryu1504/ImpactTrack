import { auth, db } from './firebase.js';
import { onAuthStateChanged, signOut } from "firebase/auth";
import { logActivity, likeActivity, getActivityFeed } from './firestore/activities.js';
import { getGlobalStats } from './firestore/stats.js';
import { searchUsers } from './firestore/users.js';

onAuthStateChanged(auth, (user) => {
  if (!user) window.location.href = 'login.html';
});

document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

// Activity form submission
document.getElementById('activityForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  await logActivity(activityType.value, parseFloat(activityAmount.value), activityUnit.value, activityNote.value);
  activityForm.reset();
  loadFeed();
  loadStats();
});

// Load global stats
async function loadStats() {
  const stats = await getGlobalStats();
  document.getElementById('globalStats').innerHTML = `
    <p>Total Compost: ${stats.totalCompostKg} kg</p>
    <p>Total Cleanup: ${stats.totalCleanupMins} minutes</p>
    <p>Users: ${stats.userCount}</p>
  `;
}

// Load feed
async function loadFeed() {
  const feed = await getActivityFeed();
  const container = document.getElementById('activityFeed');
  container.innerHTML = '';
  feed.forEach((item) => {
    const div = document.createElement('div');
    div.innerHTML = `
      <b>${item.username}</b> logged ${item.amount} ${item.unit} of ${item.type}. 
      <i>${item.note || ''}</i>
      <button data-id="${item.id}" class="likeBtn">❤️ ${item.likesCount}</button>
    `;
    container.appendChild(div);
  });
  document.querySelectorAll('.likeBtn').forEach(btn => 
    btn.addEventListener('click', () => likeActivity(btn.dataset.id))
  );
}

loadFeed();
loadStats();

// Search users
document.getElementById('searchBar').addEventListener('keypress', async (e) => {
  if (e.key === 'Enter') {
    const results = await searchUsers(e.target.value);
    if (results.length) window.location.href = `profile.html?uid=${results[0].id}`;
    else alert('No users found.');
  }
});
