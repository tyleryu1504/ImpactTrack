<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inbox – ImpactTrack</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <script type="module">
    import { requireAuth, setupNav } from './auth-common.js';
    import { auth, db } from './firebase-init.js';
    import {
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    requireAuth();
    setupNav();

    const chatsRef = collection(db, 'chats');
    const q = query(chatsRef, orderBy('created', 'asc'));
    const feed = document.getElementById('chat-feed');

    // Listen
    onSnapshot(q, snap => {
      feed.innerHTML = '';
      snap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.textContent = `${data.username}: ${data.message}`;
        feed.appendChild(div);
      });
    });

    // Send
    document
      .getElementById('chat-form')
      .addEventListener('submit', async e => {
        e.preventDefault();
        const msg = document.getElementById('chat-input').value.trim();
        if (!msg) return;
        await addDoc(chatsRef, {
          uid: auth.currentUser.uid,
          username: auth.currentUser.email,
          message: msg,
          created: serverTimestamp()
        });
        document.getElementById('chat-input').value = '';
      });
  </script>

  <h1>Inbox</h1>
  <div id="chat-feed"></div>

  <form id="chat-form">
    <input id="chat-input" type="text" placeholder="Type a message…" required>
    <button type="submit">Send</button>
  </form>

</body>
</html>
